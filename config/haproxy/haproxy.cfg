global
    log stdout format raw local0
    maxconn 10000
    # Seguran√ßa: Apenas TLS 1.3 para cumprir requisitos de Hardening
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.3

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend https_in
    bind *:443 ssl crt /etc/ssl/certs/gt-vision.pem
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Security Headers (HSTS, No-Sniff)
    http-response set-header Strict-Transport-Security "max-age=31536000"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response del-header Server

    # Rate Limiting (DDoS Protection Layer 1)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 100 }

    # Roteamento (Layer 7)
    acl is_api path_beg /api
    acl is_stream path_beg /stream
    
    use_backend kong_backend if is_api
    use_backend mediamtx_backend if is_stream

    # Health Check (Stats)
    stats enable
    stats uri /stats
    stats auth admin:admin

backend kong_backend
    server kong gt_kong:8000 check

backend mediamtx_backend
    # MediaMTX serve HLS na porta 8888
    server mediamtx gt_mediamtx:8888 check